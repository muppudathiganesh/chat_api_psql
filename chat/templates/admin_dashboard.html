{% extends 'base.html' %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<h2>Admin Dashboard</h2>
<p>Total Chats: {{ chats.count }}</p>

<!-- Chat Table -->
<div class="table-responsive mb-4">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>User</th>
                <th>Message</th>
                <th>AI Response</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody>
            {% for chat in chats %}
            <tr>
                <td>{{ chat.user.username }}</td>
                <td>{{ chat.message }}</td>
                <td>{{ chat.response }}</td>
                <td>{{ chat.timestamp }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Chat with user -->
<h3>Chat with AI/User</h3>
<div id="chat-box" class="border p-3 mb-3" style="height:300px; overflow-y:scroll;">
    {% for chat in chats %}
        {% if chat.user == request.user %}
            <div class="chat-message sent">{{ chat.message }}</div>
        {% else %}
            <div class="chat-message received"><b>{{ chat.user.username }}:</b> {{ chat.message }}</div>
        {% endif %}
    {% endfor %}
</div>

<form id="chat-form" class="mb-3">
    {% csrf_token %}
    <div class="input-group">
        <select id="recipient" class="form-select">
            <option value="">Select user</option>
            {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
        </select>
        <input type="text" id="message" class="form-control" placeholder="Type your message...">
        <button class="btn btn-primary" type="submit">Send</button>
    </div>
</form>
{% endblock %}

{% block extra_css %}
<style>
#chat-box {
    display: flex;
    flex-direction: column;
}
.chat-message {
    max-width: 60%;
    padding: 10px 15px;
    border-radius: 20px;
    margin: 5px 0;
    word-wrap: break-word;
}
.sent {
    align-self: flex-end;
    background-color: #28a745; /* admin messages */
    color: white;
}
.received {
    align-self: flex-start;
    background-color: #e0e0e0; /* user messages */
    color: black;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
const chatBox = document.getElementById('chat-box');

document.getElementById('chat-form').onsubmit = async function(e){
    e.preventDefault();
    const messageInput = document.getElementById('message');
    const message = messageInput.value.trim();
    if(!message) return;

    const recipientSelect = document.getElementById('recipient');
    const recipient_id = recipientSelect.value;

    const res = await fetch("{% url 'send_message' %}", {
        method: "POST",
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({message, recipient_id})
    });

    const data = await res.json();

    // Admin message on right
    chatBox.innerHTML += `<div class="chat-message sent">${message}</div>`;
    // AI/user response on left
    chatBox.innerHTML += `<div class="chat-message received"><b>Response:</b> ${data.response}</div>`;
    
    messageInput.value = '';
    chatBox.scrollTop = chatBox.scrollHeight;
};

document.getElementById('message').addEventListener('keypress', function(e){
    if(e.key === 'Enter'){
        e.preventDefault();
        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
    }
});
</script>
{% endblock %}
