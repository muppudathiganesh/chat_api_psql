{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h3>Chat with {{ selected_user.username }}</h3>

    <div class="chat-box border rounded p-3 mb-3"
         style="height: 400px; overflow-y: auto; background: #f7f7f7;">

        {% for msg in messages %}
            {% if msg.sender == request.user %}
                <!-- Admin sent -->
                <div class="d-flex justify-content-end mb-2">
                    <div class="p-2 rounded"
                         style="max-width: 70%; background: #d4edda;">
                        <strong>You:</strong> {{ msg.content }}<br>
                        <small class="text-muted">{{ msg.timestamp }}</small>
                    </div>
                </div>
            {% else %}
                <!-- User sent -->
                <div class="d-flex justify-content-start mb-2">
                    <div class="p-2 rounded"
                         style="max-width: 70%; background: #e2e3e5;">
                        <strong>{{ msg.sender.username }}:</strong> {{ msg.content }}<br>
                        <small class="text-muted">{{ msg.timestamp }}</small>
                    </div>
                </div>
            {% endif %}
        {% endfor %}

    </div>

    <form id="sendForm">
        {% csrf_token %}
        <input type="hidden" id="receiver" value="{{ selected_user.id }}">
        <div class="input-group">
            <input type="text" id="content" class="form-control" placeholder="Type message...">
            <button class="btn btn-primary">Send</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById("sendForm").onsubmit = async function(e){
    e.preventDefault();

    let content = document.getElementById("content").value;
    let receiver = document.getElementById("receiver").value;

    let res = await fetch("{% url 'admin_send_message' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ content, receiver })
    });

    location.reload();  // refresh to show message
};
</script>
{% endblock %}
