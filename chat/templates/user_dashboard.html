{% extends 'base.html' %}
{% block title %}User Dashboard{% endblock %}

{% block content %}
<h2>Chat</h2>

<div id="chat-box" class="border p-3 mb-3" style="height:400px; overflow-y:scroll;">
    {% for chat in chats %}
        {% if chat.user == request.user %}
            <!-- SENT BY USER → GREEN RIGHT -->
            <div class="chat-message sent">
                {{ chat.message }}
            </div>
        {% else %}
            <!-- RECEIVED FROM ADMIN → GRAY LEFT -->
            <div class="chat-message received">
                {{ chat.message }}
            </div>
        {% endif %}
    {% endfor %}
</div>

<form id="chat-form">
    {% csrf_token %}
    <div class="input-group">
        <input type="text" id="message" class="form-control" placeholder="Type your message...">
        <button class="btn btn-primary" type="submit">Send</button>
    </div>
</form>

{% endblock %}

{% block extra_css %}
<style>
#chat-box {
    display: flex;
    flex-direction: column;
}

.chat-message {
    max-width: 60%;
    padding: 10px 15px;
    border-radius: 20px;
    margin: 6px 0;
    word-wrap: break-word;
}

/* SENT (RIGHT, GREEN) */
.sent {
    align-self: flex-end;
    background-color: #28a745;
    color: white;
}

/* RECEIVED (LEFT, GRAY) */
.received {
    align-self: flex-start;
    background-color: #e0e0e0;
    color: black;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const chatBox = document.getElementById('chat-box');

document.getElementById('chat-form').onsubmit = async function(e){
    e.preventDefault();
    const messageInput = document.getElementById('message');
    const message = messageInput.value.trim();
    if(!message) return;

    const res = await fetch("{% url 'send_message' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ message })
    });

    const data = await res.json();

    // SENT → RIGHT GREEN
    chatBox.innerHTML += `<div class="chat-message sent">${message}</div>`;

    // RECEIVED → LEFT GRAY
    chatBox.innerHTML += `<div class="chat-message received">${data.response}</div>`;

    messageInput.value = "";
    chatBox.scrollTop = chatBox.scrollHeight;
};
</script>
{% endblock %}
